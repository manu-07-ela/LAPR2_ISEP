<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecordSampleController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Sem2App</a> &gt; <a href="index.source.html" class="el_package">app.controller</a> &gt; <span class="el_source">RecordSampleController.java</span></div><h1>RecordSampleController.java</h1><pre class="source lang-java linenums">package app.controller;

import app.adapter.interfaces.ExternalModuleBarcode;
import app.domain.model.Company;
import app.domain.model.laboratories.ClinicalAnalysisLaboratory;
import app.domain.model.testrelated.Sample;
import app.domain.model.testrelated.Test;
import app.domain.model.testrelated.BarcodeDomain;
import app.domain.store.ClinicalAnalysisLaboratoryStore;
import app.domain.store.SampleStore;
import app.domain.store.TestStore;
import app.mappers.TestMapper;
import app.mappers.dto.ClinicalAnalysisLaboratoryDTO;
import app.mappers.dto.TestDTO;
import net.sourceforge.barbecue.Barcode;
import net.sourceforge.barbecue.BarcodeException;
import net.sourceforge.barbecue.BarcodeImageHandler;
import net.sourceforge.barbecue.output.OutputException;

import javax.imageio.ImageIO;
import javax.swing.*;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.io.Serializable;
import java.text.DecimalFormat;
import java.util.List;
import java.util.Properties;

/**
 * Represents the controller used to record samples in a test
 * @author Manuela Leite &lt;1200720@isep.ipp.pt&gt;
 */
public class RecordSampleController implements Serializable {
    /**
     * Represents a instance of test store
     */
    private final TestStore testStore;
    /**
     * Represents a instance of sample store
     */
    private final SampleStore sampleStore;
    /**
     * Represents a instance of company
     */
    private final Company company;
    /**
     * Represents a instance of test mapper
     */
    private final TestMapper testMapper;
    /**
     * Counts the instances of barcodes
     */
    private static int instancesOfBarcode;


    /**
     * Constructs an instance of {@code RecordSampleController}
     */
<span class="nc" id="L61">    public RecordSampleController() {</span>
<span class="nc" id="L62">        this.company = App.getInstance().getCompany();</span>
<span class="nc" id="L63">        this.testStore = company.getTestStore();</span>
<span class="nc" id="L64">        this.sampleStore = company.getChemicalLaboratory().getSampleStore();</span>
<span class="nc" id="L65">        this.testMapper = new TestMapper();</span>
<span class="nc" id="L66">    }</span>

    /**
     * Returns a DTO-type list of test waiting for samples in the system
     * @return A DTO-type list of tests waiting for samples
     */
    public List&lt;TestDTO&gt; getListOfTestsWaitingForSample(ClinicalAnalysisLaboratory clinicalAnalysisLaboratory){
<span class="nc" id="L73">        return testMapper.toDto(testStore.getListOfTestWaitingForSample(clinicalAnalysisLaboratory));</span>
    }

    /**
     * Get a test by its internal code
     * @param testDto a test dto which the internal code will be taken to compare with the tests stored in the TestStore
     * @return the test corresponding to the desired internal code
     */
    public Test getTestByInternalCode(TestDTO testDto){
<span class="nc" id="L82">        return testStore.getTestByInternalCode(testDto.getInternalCode());</span>
    }

    /**
     * Builds an instance of the API that will be used to generate the bar codes.
     * @return an instance of the External module to be used by system
     * @throws ClassNotFoundException if the class I try to instantiate does not exist
     * @throws InstantiationException if the class instance is unsuccessful
     * @throws IllegalAccessException if I try to access a method of the class that I don't have permission
     */
    public ExternalModuleBarcode getExternalModule() throws ClassNotFoundException, InstantiationException, IllegalAccessException {
<span class="nc" id="L93">        Properties props = App.getInstance().getProps();</span>
<span class="nc" id="L94">        String classAux = props.getProperty(&quot;Controller.BarcodeAdapter.Class&quot;);</span>
<span class="nc" id="L95">        Class&lt;?&gt; oClass = Class.forName(classAux);</span>
<span class="nc" id="L96">        ExternalModuleBarcode api = (ExternalModuleBarcode) oClass.newInstance();</span>
<span class="nc" id="L97">        return api;</span>
    }

    /**
     * Generates the barcodes that will be associated with the samples in the future
     * @return the barcode
     * @throws ClassNotFoundException if the class I try to instantiate does not exist
     * @throws InstantiationException if the class instance is unsuccessful
     * @throws IllegalAccessException if I try to access a method of the class that I don't have permission
     * @throws IOException if an input or output error occurs
     * @throws BarcodeException if the barcode cannot be generated
     */
    public BarcodeDomain generateBarcode() throws ClassNotFoundException, InstantiationException, IllegalAccessException, IOException, BarcodeException {
<span class="nc" id="L110">        DecimalFormat df = new DecimalFormat(&quot;00000000000&quot;);</span>
<span class="nc" id="L111">        instancesOfBarcode++;</span>
<span class="nc" id="L112">        String barcodeNumber = df.format(instancesOfBarcode);</span>
<span class="nc" id="L113">        ExternalModuleBarcode api = getExternalModule();</span>
<span class="nc" id="L114">        return api.generateBarcode(barcodeNumber);</span>
    }

    /**
     * Show the barcodes
     * @param barcode the barcode that will be shown
     */
    public void showBarcodes(BarcodeDomain barcode){
<span class="nc" id="L122">        JFrame frame = new JFrame(&quot;Barcode&quot;);</span>
<span class="nc" id="L123">        frame.getContentPane().add((Component) barcode.getBarcode());</span>
<span class="nc" id="L124">        frame.setSize(300, 300);</span>
<span class="nc" id="L125">        frame.setDefaultCloseOperation(JFrame.HIDE_ON_CLOSE);</span>
<span class="nc" id="L126">        frame.setVisible(true);</span>
<span class="nc" id="L127">    }</span>

    /**
     * Associates a barcode with a sample
     * @param barcode the barcode that will be associated with the sample
     * @return the sample
     */
    public Sample associateBarcodeWithSample(BarcodeDomain barcode){
<span class="nc" id="L135">        return sampleStore.createSample(barcode);</span>

    }

    /**
     * Associate a test with the samples
     * @param test the test we desired to associated with the sample
     * @param samples the sample we desired to associated with the test
     * @return true, if the association successful. False, otherwise.
     */
    public boolean associateSamplesWithTest(Test test, Sample samples){
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (sampleStore.validateSample(samples)){</span>
<span class="nc" id="L147">            test.addSamples(samples);</span>
<span class="nc" id="L148">            return true;</span>
        }
<span class="nc" id="L150">        return false;</span>
    }

    /**
     * Method responsible for writing the barcodes in a folder
     * @param image the barcode that will be saved
     * @param fileName the name of the file associated with the barcode
     */
    public void imageIoWrite(BufferedImage image, String fileName) {
        try {
<span class="nc" id="L160">            String pwd = System.getProperty(&quot;user.dir&quot;);</span>

<span class="nc" id="L162">            File barcodes = new File(pwd + &quot;\\src\\main\\barcodes&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (!barcodes.exists()) {</span>
<span class="nc" id="L164">                barcodes.mkdirs();</span>
            }
<span class="nc" id="L166">            File outputFile = new File(pwd + &quot;\\src\\main\\barcodes\\&quot;+fileName+&quot;.jpeg&quot;);</span>

<span class="nc" id="L168">            ImageIO.write(image, &quot;jpeg&quot;, outputFile);</span>
<span class="nc" id="L169">        } catch (IOException e) {</span>
<span class="nc" id="L170">            System.out.println(&quot;Exception occured :&quot; + e.getMessage());</span>
<span class="nc" id="L171">        }</span>
<span class="nc" id="L172">        System.out.println(&quot;The image was successfully saved to the \&quot;barcodes\&quot; folder.&quot;);</span>
<span class="nc" id="L173">    }</span>

    /**
     * Transforms a BarcodeDomain in a BufferedImage
     * @param barcode the BarcodeDomain that will be converted
     * @return the bufferedImage
     * @throws OutputException if the conversion is not successful
     */
    public BufferedImage barcodeImage(BarcodeDomain barcode) throws OutputException {
<span class="nc" id="L182">        return BarcodeImageHandler.getImage((Barcode) barcode.getBarcode());</span>
    }

    /**
     * Save the sample
     * @param sample the sample we intend to save
     * @return true if the sample was saved, false otherwise
     */
    public boolean saveSample(Sample sample){
<span class="nc" id="L191">        return sampleStore.saveSample(sample);</span>
    }

    /**
     * Get the list of existing laboratories in the system
     * @return the list of laboratories
     */
    public List&lt;ClinicalAnalysisLaboratory&gt; getListOfLaboratories(){
<span class="nc" id="L199">        return company.getClinicalAnalysisLaboratoryStore().getClinicalAnalysisLaboratoryList();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>